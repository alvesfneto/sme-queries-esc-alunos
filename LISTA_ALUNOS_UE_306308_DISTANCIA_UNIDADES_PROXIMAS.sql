/*

Solicitamos o estudo ponto a ponto dos endereços dos alunos matriculados na 
CR.P.CONV - JOEL CORREA DE AVILA, LAR ASSIST A CRIANCA - 306308 em relação as creches até 3,0 km.
*/

SELECT 
* 
INTO ##ALUNOS_ESCOLA_306308

FROM [dbo].[VW_ALUNOS_ENDERECOS_DISTRITO_SETOR] WHERE CD_ESCOLA=306308


DROP TABLE ##LISTA_ALUNOS_UE_306308_DISTANCIA_UNIDADES_PROXIMAS
SELECT DISTINCT
CONCAT(A.CD_ESCOLA,' - ',A.SG_TP_ESCOLA,' ',A.NOME_ESCOLA) AS ESCOLA_ORIGEM,
A.ETAPA,
A.SERIE_ANO,
A.CD_TURMA_ESCOLA,
A.COD_ALUNO,
NOME_ALUNO,
UPPER(CONCAT( A.TP_LOGRADOURO,' ',ENDEREÇO)) AS ENDERECO_ALUNO,
A.NR,
A.BAIRRO,
B.CD_ESCOLA AS COD_ESC_DESTINO,
CONCAT (B.SG_TP_ESCOLA,' ',B.NOMESC) AS ESCOLA_DESTINO,
FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO*1000000 - (B.CD_COORDENADA_GEO_Y * 1000000) ),2) +  POWER((LON_ALUNO*1000000  - (B.CD_COORDENADA_GEO_X * 1000000)),2)) / 10)/0.6) AS DIST_ESCOLA_DESTINO,
A.CRDATE
INTO ##LISTA_ALUNOS_UE_306308_DISTANCIA_UNIDADES_PROXIMAS
FROM ##ALUNOS_ESCOLA_306308 A, SME_ESCOLA_DIARIO B
WHERE B.TP_ESCOLA IN (10,11,12,18,28,31) AND B.CD_ESCOLA<>306308
AND FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO*1000000 - (B.CD_COORDENADA_GEO_Y * 1000000) ),2) +  POWER((LON_ALUNO*1000000  - (B.CD_COORDENADA_GEO_X * 1000000)),2)) / 10)/0.6)<=3000

--SELECT * FROM ##LISTA_ALUNOS_UE_306308_DISTANCIA_UNIDADES_PROXIMAS