/*

Prezado José
Peço seus préstimos para nos fornecer relatório para alunos matriculados com distância linear a menos 1km para o endereço 
RUBENS MONTANARO DE BORBA , 459. (-23.710934645033056, -46.692888274703954) - CR.P.CONV   	EQUILIBRIO DE INTERLAGOS, SOC BENEF	306281


No relatório deve constar

Nome do aluno
EOL do aluno
Agrupamento
Endereço do aluno (separado por coluna, endereço e bairro)
Unidade de matrícula
Distância da Unidade de matrícula
Distância para o endereço indicado
Se possui TEG
Se tem deficiência

*/
DROP TABLE ##alunos_infantil_distantes_ate_1km_RUA_RUBENS_MONTANARO_DE_BORBA_459
SELECT 
ETAPA,
SERIE_ANO,
NOME_ALUNO,
COD_ALUNO AS 'EOL_ALUNO',
CONVERT(DATE,DT_NASCIMENTO_ALUNO, 103) AS 'DATA_NASCIMENTO',
--Apenas aluno de Infantil
CONCAT(TP_LOGRADOURO,' ', ENDEREÇO) AS ENDERECO,
NR,
COMPL,
BAIRRO,
DRE,
CD_ESCOLA,
SG_TP_ESCOLA,
NOME_ESCOLA,
--Unidade de Matrícula
DIST_ESCOLA AS 'Dist_unidade_matrícula',
FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO*1000000 - (-23.710934645033056 * 1000000) ),2) +  POWER((LON_ALUNO*1000000  - (-46.692888274703954 * 1000000)),2)) / 10)/0.6) AS 'DIST_RUA_RUBENS MONTANARO DE BORBA 459',
CASE WHEN DEF1 IS NOT NULL THEN 'S' ELSE NULL END AS 'DEFICIENCIA',
CASE WHEN TEG ='SIM' THEN 'S' ELSE NULL END AS 'TEG',
A.CRDATE

INTO ##alunos_infantil_distantes_ate_1km_RUA_RUBENS_MONTANARO_DE_BORBA_459

FROM VW_ALUNOS_ENDERECOS_DISTRITO_SETOR A
LEFT JOIN (SELECT DISTINCT CD_ALUNO,DEF1 FROM SME_ALUNOS_DIARIO
	  WHERE DEF1 IS NOT NULL AND SG_ETAPA='ED INF') B ON A.COD_ALUNO=B.CD_ALUNO
LEFT JOIN (SELECT DISTINCT CD_ALUNO,TEG,TEG_BARREIRA,DC_MOTIVO_TRANSPORTE FROM ALUNOS_COM_TEG
		   WHERE TEG = 'SIM'
		   AND SG_ETAPA='ED INF') C ON A.COD_ALUNO=C.CD_ALUNO

WHERE ETAPA = 'ED INF' AND DRE='DRE - CS'
AND FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO*1000000 - (-23.710934645033056 * 1000000) ),2) +  POWER((LON_ALUNO*1000000  - (-46.692888274703954 * 1000000)),2)) / 10)/0.6)<=1000

--SELECT * FROM ##alunos_infantil_distantes_ate_1km_RUA_RUBENS_MONTANARO_DE_BORBA_459