
/*Solicitamos arquivo dos bebês e crianças de 0 a 3 anos matriculados na Rede com até 2,0km 
do CEI Ibirapuera - Rua Abílio Soares, SN - Paraíso - CEP 04005-002.--400883  - -23.574819 -46.646595
*/


DROP TABLE ##ALUNOS_ATE_3_ANOS_PROXIMOS_CEI_IBIRAPUERA
SELECT 
DRE,
B.CD_ESCOLA,
B.SG_TP_ESCOLA,
NOMESC,
SG_ETAPA,
A.SG_SERIE_ENSINO,
COD_ALUNO,
NM_ALUNO,
DATEDIFF(YY,A.DT_NASCIMENTO_ALUNO,GETDATE()) AS IDADE,
C.DIST_ESCOLA,
'CEI IBIRAPUERA'AS DESTINO, 
FLOOR(FLOOR(SQRT(POWER((C.LAT_ALUNO * 1000000 - (-23.574819 * 1000000) ),2) +  
				 POWER((C.LON_ALUNO * 1000000 - (-46.646595 * 1000000)),2)) / 10)/0.6) AS DIST_DESTINO,
CONVERT(VARCHAR,A.CRDATE-1,103) AS DT_BASE

INTO ##ALUNOS_ATE_3_ANOS_PROXIMOS_CEI_IBIRAPUERA

 FROM SME_ALUNOS_DIARIO A
JOIN SME_ESCOLA_DIARIO B ON A.CD_ESCOLA=B.CD_ESCOLA
JOIN VW_ALUNOS_ENDERECOS C ON A.CD_ALUNO=C.COD_ALUNO
WHERE FLOOR(SQRT(POWER((C.LAT_ALUNO * 1000000 - (-23.574819 * 1000000) ),2) +  
				 POWER((C.LON_ALUNO * 1000000 - (-46.646595 * 1000000)),2)) / 10)/0.6<=2000
	 AND DATEDIFF(YY,A.DT_NASCIMENTO_ALUNO,GETDATE())<=3
	 AND B.TP_ESCOLA<>15

--SELECT * FROM ##ALUNOS_ATE_3_ANOS_PROXIMOS_CEI_IBIRAPUERA
---------------------------------------------------------------------------------------

