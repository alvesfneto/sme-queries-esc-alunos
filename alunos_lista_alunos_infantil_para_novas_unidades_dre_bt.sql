  /*
  Para estudo de demanda, solicitamos uma planilha com os dados completo dos alunos por agrupamento 
( 
nome, 
filiação, 
data de nascimento, 
endereço, 
Bairro,
CEP, 
Distrito da unidade de origem, 
EMEI mais próxima da residência do aluno no caso do agrupamento de MGII), das seguintes unidades escolares:

            019239 - EMEI MAURO BAPTISTA 
            019515 - EMEI PERIMETRAL 
            019340 - EMEI ROBERTO BURLE MAX 
            019653 - CEMEI MORUMBI 
            019532 - CEMEI IRAPARÁ 
            019375 - EMEI CEU PARAISÓPOLIS 

			400893 - CEI MONSENHOR JONAS ABIB (MGII e Infantil) 
            308994 - CEI ESPAÇO CRIANÇA (MG II e Infantil) 
            309351 - CEI DANDINHA (MG II e Infantil) 
            309204 - CEI FAZENDA PEDRO E MARIA (MG II e Infantil) 

            309291 - CEI ANGLICANA ANA PAULA QUINTÃO (MGII) 
            309555 - CEI ANGLICANA BERNARDO GIACOMINI GONÇALVES (MGII) 
            309292 - CEI ANGLICANA CRISTINA NARDINELLI (MGII) 
            307398 - CEI ANGLICANA RENATA EUGENIA RODRIGUES (MGII) 
            326233 - CEI DONA DIVA I (MGII) 
            309205 - CEI DULCE MARINHO (MGII) 
            309520 - CEI GIRASSOL (MGII) 
            308828 - CEI SANTA ESCOLÁSTICA (MGII) 
            309801 - CEI SANTO ETEVÃO REI (MGII) 
*/

DROP TABLE ##LISTA_ALUNOS_AMOSTRA_SOLICITADA
SELECT 
DRE,
A.CD_ESCOLA,
SG_TP_ESCOLA,
NOMESC,
SG_ETAPA,
SG_SERIE_ENSINO,
CD_ALUNO,
NM_ALUNO,
NM_MAE_ALUNO,
NM_PAI_ALUNO,
CONVERT(DATE,DT_NASCIMENTO_ALUNO,103) AS DT_NASC,
B.ENDERECO,
B.NR,
B.COMPL,
B.BAIRRO,
B.CEP,
DIST_ESCOLA,
LAT_ALUNO,
LON_ALUNO
INTO ##LISTA_ALUNOS_AMOSTRA_SOLICITADA
FROM SME_ALUNOS_DIARIO A
JOIN (SELECT DISTINCT
      COD_ALUNO,
      CONCAT(TP_LOGRADOURO,' ',ENDEREÇO) AS ENDERECO,
      NR,
      COMPL,
      BAIRRO,
      CEP,
      DIST_ESCOLA,
      LAT_ALUNO,
      LON_ALUNO
      FROM VW_ALUNOS_ENDERECOS) B ON A.CD_ALUNO=B.COD_ALUNO
JOIN SME_ESCOLA_DIARIO C ON A.CD_ESCOLA=C.CD_ESCOLA
WHERE 
A.CD_ESCOLA IN (019239,019515,019340,019653,019532,019375)
OR (A.CD_ESCOLA IN (400893,308994,309351,309204) AND CD_SERIE_ENSINO IN(28,297))
OR (A.CD_ESCOLA IN (309291,309555,309292,307398,326233,309205,309520,308828,309801,309186) AND CD_SERIE_ENSINO=28)

--SELECT * FROM ##LISTA_ALUNOS_AMOSTRA_SOLICITADA

DROP TABLE  ##DESTINO
SELECT 
DRE,
CD_ESCOLA,
SG_TP_ESCOLA,
NOMESC, 
ENDERECO,
NR,
COMPL,
BAIRRO,
CD_COORDENADA_GEO_Y,
CD_COORDENADA_GEO_X
INTO ##DESTINO
FROM SME_ESCOLA 
WHERE TP_ESCOLA IN (2,17,28,31) 
AND CD_SIT=1 AND DRE='DRE - BT' 
AND CD_ESCOLA NOT IN(019239,019515,019340,019653,019532,019375)
--SELECT * FROM ##DESTINO

DROP TABLE ##LISTA_ALUNOS_AMOSTRA_SOLICITADA_UNID_DESTINO
SELECT 
A.*,
B.CD_ESCOLA AS CD_UNID_DESTINO,
CONCAT(B.SG_TP_ESCOLA,' ',B.NOMESC) AS UNID_DESTINO,
FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (CD_COORDENADA_GEO_Y * 1000000) ),2) +  
				 POWER((LON_ALUNO * 1000000 - (CD_COORDENADA_GEO_X * 1000000)),2)) / 10)/0.6) AS DIST_DESTINO
INTO ##LISTA_ALUNOS_AMOSTRA_SOLICITADA_UNID_DESTINO
FROM ##LISTA_ALUNOS_AMOSTRA_SOLICITADA A, ##DESTINO B
WHERE 
FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (CD_COORDENADA_GEO_Y * 1000000) ),2) +  
				 POWER((LON_ALUNO * 1000000 - (CD_COORDENADA_GEO_X * 1000000)),2)) / 10)/0.6)<=3000


--SELECT * FROM ##LISTA_ALUNOS_AMOSTRA_SOLICITADA_UNID_DESTINO

