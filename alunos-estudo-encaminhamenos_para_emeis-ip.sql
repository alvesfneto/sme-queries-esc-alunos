/*
SELECT cd_sit,sg_tp_escola,CD_ESCOLA,NOMESC,DRE FROM SME_ESCOLA_DIARIO WHERE NOMESC LIKE '%Mary Anne%' and cd_sit=1

1 - Solicitamos o estudo ponto a ponto dos endereços dos alunos até 1,5 KM para as EMEIS: 
Gabriel Prestes(091863), 
Patrícia Galvão(091855), 
Armando de Arruda(091871) e 
Monteiro Lobato(090425) 
- (somente alunos que irão para a EMEI)


CEI Lar Nossa Senhora da Consolação -306528
CEI Aconchego II - 307066
CEI Aconchego - 306681
CEI São Domingos - 309479
CEI Mãe Achiropita - 306740
CEI Cantinho do Byan - 400661
*/
DROP ´TABLE ##alunos_estudo_encaminhamenos_para_emeis_ip_1
SELECT 
DRE,
CD_ESCOLA,
SG_TP_ESCOLA,
NOME_ESCOLA,
ETAPA,
SERIE_ANO,
COD_ALUNO,
NOME_ALUNO,
DT_NASCIMENTO_ALUNO,
B.SG_SERIE_ENSINO,

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.545576 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.659656 * 1000000)),2)) / 10)/0.6)<=1500 THEN 
	      FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.545576 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.6596561 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI MONTEIRO LOBATO',

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.548937 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.647337 * 1000000)),2)) / 10)/0.6)<=1500 THEN 
          FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.548937 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.647337 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI PATRICIA GALVAO',

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.548279 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.650953 * 1000000)),2)) / 10)/0.6)<=1500 THEN
         FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.548279 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.650953 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI GABRIEL PRESTES',

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.542674 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.643022 * 1000000)),2)) / 10)/0.6)<=1500 THEN
          FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.542674 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.643022 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI ARMANDO DE ARRUDA PEREIRA',
A.CRDATE

INTO ##alunos_estudo_encaminhamenos_para_emeis_ip_1

 FROM [dbo].[VW_ALUNOS_ENDERECOS_DISTRITO_SETOR] A
 JOIN (
        SELECT	DISTINCT --EM TESE NÃO DEVERIA HAVER DUPLICADAS, MAS POR SEGURANÇA
       	CD_FAIXA,
       	CONVERT(DATETIME,CONVERT(VARCHAR(4),DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA) + CONVERT(VARCHAR(2), MM_INICIO_FAIXA) + CONVERT(VARCHAR(2), DD_INICIO_FAIXA)) AS DT_INICIO_FAIXA,
       	CONVERT(DATETIME,CONVERT(VARCHAR(4),DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_FIM_FAIXA) + CONVERT(VARCHAR(2), MM_FIM_FAIXA) + CONVERT(VARCHAR(2), DD_FIM_FAIXA)) AS DT_FIM_FAIXA,
       	CASE 
       		WHEN (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ - (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA)) = 1 THEN '0 E 1 ANO'
       		ELSE CONVERT(VARCHAR(2),(DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ - (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA))) + ' ANOS' 
       		END AS IDADE,
       	T1.CD_SERIE_ENSINO, 
       	T2.DC_SERIE_ENSINO,
       	T2.CD_CICLO_ENSINO,
       	T2.SG_SERIE_ENSINO,
       	T2.cd_etapa_ensino,
       	T3.dc_etapa_ensino
       FROM	D_FAIXA_SERIE AS T1
       INNER JOIN D_SERIE_ENSINO AS T2 ON T1.CD_SERIE_ENSINO = T2.CD_SERIE_ENSINO
       INNER JOIN D_ETAPA_ENSINO AS T3 ON T2.cd_etapa_ensino = T3.cd_etapa_ensino
       WHERE	T1.DT_INICIO <= GETDATE()
       		AND (T1.DT_FIM IS NULL OR T1.DT_FIM >= CONVERT(DATE,GETDATE()))
       		AND TP_FAIXA =5) B ON A.DT_NASCIMENTO_ALUNO BETWEEN B.DT_INICIO_FAIXA AND B.DT_FIM_FAIXA
 WHERE CD_ESCOLA IN (306528,307066,306681,309479,306740,400661) AND B.cd_faixa=4

 --SELECT * FROM ##alunos_estudo_encaminhamenos_para_emeis_ip_1


/*
 2 - Solicitamos o estudo ponto a ponto dos endereços dos alunos da CEIs abaixo até 1,5 KM para as EMEIs: 
Zenaide Grandini(092479) e 
Afonso Celso(092461)
- (somente alunos que irão para a EMEI):

CEI Doce Saber;- 309239
CEI Padre Pacomio; - 400844
CEI Nossa Senhora do Carmo, - 306477
CEI Elohim Adonai III, - 309007
CEI Irmã Jacinta, - 309593
CEI Vovó Ana; - 309050
CEI Mary Anne; - 306476

*/
DROP TABLE ##alunos_estudo_encaminhamenos_para_emeis_ip_2
SELECT 
DRE,
CD_ESCOLA,
SG_TP_ESCOLA,
NOME_ESCOLA,
ETAPA,
SERIE_ANO,
COD_ALUNO,
NOME_ALUNO,
DT_NASCIMENTO_ALUNO,
B.SG_SERIE_ENSINO,

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.599225 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.562272 * 1000000)),2)) / 10)/0.6)<=1500 THEN 
	      FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.599225 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.562272 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI AFONSO CELSO',

CASE WHEN FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.605181 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.560357 * 1000000)),2)) / 10)/0.6)<=1500 THEN 
          FLOOR(FLOOR(SQRT(POWER((LAT_ALUNO * 1000000 - (-23.605181 * 1000000) ),2) +  
				           POWER((LON_ALUNO * 1000000 - (-46.560357 * 1000000)),2)) / 10)/0.6) ELSE NULL END AS 'EMEI ZENAIDE GRANDINI',
A.CRDATE

INTO ##alunos_estudo_encaminhamenos_para_emeis_ip_2
 FROM [dbo].[VW_ALUNOS_ENDERECOS_DISTRITO_SETOR] A
 JOIN (
        SELECT	DISTINCT --EM TESE NÃO DEVERIA HAVER DUPLICADAS, MAS POR SEGURANÇA
       	CD_FAIXA,
       	CONVERT(DATETIME,CONVERT(VARCHAR(4),DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA) + CONVERT(VARCHAR(2), MM_INICIO_FAIXA) + CONVERT(VARCHAR(2), DD_INICIO_FAIXA)) AS DT_INICIO_FAIXA,
       	CONVERT(DATETIME,CONVERT(VARCHAR(4),DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_FIM_FAIXA) + CONVERT(VARCHAR(2), MM_FIM_FAIXA) + CONVERT(VARCHAR(2), DD_FIM_FAIXA)) AS DT_FIM_FAIXA,
       	CASE 
       		WHEN (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ - (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA)) = 1 THEN '0 E 1 ANO'
       		ELSE CONVERT(VARCHAR(2),(DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ - (DATEPART(YYYY, GETDATE()) /*@ANO_REFERENCIA_PARAMETRO_MATRICULA*/ + AN_INCREMENTO_INICIO_FAIXA))) + ' ANOS' 
       		END AS IDADE,
       	T1.CD_SERIE_ENSINO, 
       	T2.DC_SERIE_ENSINO,
       	T2.CD_CICLO_ENSINO,
       	T2.SG_SERIE_ENSINO,
       	T2.cd_etapa_ensino,
       	T3.dc_etapa_ensino
       FROM	D_FAIXA_SERIE AS T1
       INNER JOIN D_SERIE_ENSINO AS T2 ON T1.CD_SERIE_ENSINO = T2.CD_SERIE_ENSINO
       INNER JOIN D_ETAPA_ENSINO AS T3 ON T2.cd_etapa_ensino = T3.cd_etapa_ensino
       WHERE	T1.DT_INICIO <= GETDATE()
       		AND (T1.DT_FIM IS NULL OR T1.DT_FIM >= CONVERT(DATE,GETDATE()))
       		AND TP_FAIXA =5) B ON A.DT_NASCIMENTO_ALUNO BETWEEN B.DT_INICIO_FAIXA AND B.DT_FIM_FAIXA
 WHERE CD_ESCOLA IN (309239,400844,306477,309007,309593,309050,306476) AND B.cd_faixa=4

 --SELECT * FROM ##alunos_estudo_encaminhamenos_para_emeis_ip_2

 /*
 SELECT 
 DRE,
 CD_ESCOLA,
 SG_TP_ESCOLA,
 NOMESC,
 CD_COORDENADA_GEO_Y,
 CD_COORDENADA_GEO_X 
 FROM SME_ESCOLA_DIARIO 
 WHERE CD_ESCOLA IN (092479,092461)
 */








		